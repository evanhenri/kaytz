---
- name: Find current stable kubernetes release
  uri:
    url: https://storage.googleapis.com/kubernetes-release/release/stable.txt
    return_content: yes
  register: k8s_version_raw

- name: Store kubernetes release response in kubernetes_version
  set_fact:
    k8s_version: "{{ k8s_version_raw.content | replace('\n', '') }}"

- name: Detect installed kubectl version
  shell: kubectl version 2> /dev/null | sed -n -e 's/.*GitVersion:"//p' | cut -d\" -f1
  register: kubectl_version_raw

- name: Making kubectl_version a usable template variable
  set_fact:
    kubectl_version: "{{ kubectl_version_raw.stdout | replace('\n', '') }}"

- name: Downloading kubectl
  get_url:
    url: "https://storage.googleapis.com/kubernetes-release/release/{{ k8s_version }}/bin/linux/amd64/kubectl"
    dest: /usr/local/bin/kubectl
    mode: 0755
    force: yes
  become: true
  when: k8s_version != kubectl_version
